-- Create Database (if it doesn't exist)
CREATE DATABASE IF NOT EXISTS library_system;
USE library_system;

-- Drop tables if they already exist to ensure a clean start
-- (Order matters due to foreign key constraints)
DROP TABLE IF EXISTS management_log, payment, penalty, reservation, borrowing_record, book_copy, semester, book, users;

-- ==========================
-- USERS TABLE
-- ==========================
CREATE TABLE users (
    UserID INT AUTO_INCREMENT PRIMARY KEY,
    Username VARCHAR(20) NOT NULL UNIQUE,
    Name VARCHAR(100) NOT NULL,
    Role ENUM('Student','Teacher','Librarian','Staff') NOT NULL,
    Email VARCHAR(100) NOT NULL UNIQUE,
    PasswordHash VARCHAR(255) NOT NULL
);

-- ==========================
-- SEMESTER TABLE
-- ==========================
CREATE TABLE semester (
    SemesterID INT AUTO_INCREMENT PRIMARY KEY,
    StartDate DATE NOT NULL,
    EndDate DATE NOT NULL,
    Student_Borrow_Limit INT DEFAULT 3
);

-- ==========================
-- BOOK TABLE
-- ==========================
CREATE TABLE book (
    BookID INT AUTO_INCREMENT PRIMARY KEY,
    Title VARCHAR(150) NOT NULL,
    Author VARCHAR(100) DEFAULT NULL,
    ISBN VARCHAR(30) DEFAULT NULL UNIQUE,
    Price DECIMAL(10,2) DEFAULT NULL,
    Category VARCHAR(50) DEFAULT NULL,
    CoverImagePath VARCHAR(255) DEFAULT NULL,
    Status ENUM('Available','Reserved','Borrowed','Archived') DEFAULT 'Available'
);

-- ==========================
-- BOOK COPY TABLE
-- ==========================
CREATE TABLE book_copy (
    CopyID INT AUTO_INCREMENT PRIMARY KEY,
    BookID INT NOT NULL,
    Status ENUM('Available','Borrowed','Reserved','Lost','Damaged') DEFAULT 'Available',
    FOREIGN KEY (BookID) REFERENCES book(BookID) ON DELETE CASCADE
);

-- ==========================
-- BORROWING RECORD TABLE
-- ==========================
CREATE TABLE borrowing_record (
    BorrowID INT AUTO_INCREMENT PRIMARY KEY,
    UserID INT NOT NULL,
    CopyID INT NOT NULL,
    BookID INT NOT NULL,
    SemesterID INT DEFAULT NULL,
    BorrowDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    DueDate DATETIME NOT NULL,
    ReturnDate DATETIME DEFAULT NULL,
    Status ENUM('Borrowed','Returned','Overdue','Lost') DEFAULT 'Borrowed',
    ProcessedBy INT DEFAULT NULL,
    
    FOREIGN KEY (UserID) REFERENCES users(UserID) ON DELETE CASCADE,
    FOREIGN KEY (CopyID) REFERENCES book_copy(CopyID) ON DELETE CASCADE,
    FOREIGN KEY (SemesterID) REFERENCES semester(SemesterID) ON DELETE SET NULL,
    FOREIGN KEY (ProcessedBy) REFERENCES users(UserID) ON DELETE SET NULL
);

-- ==========================
-- RESERVATION TABLE
-- ==========================
CREATE TABLE reservation (
    ReservationID INT AUTO_INCREMENT PRIMARY KEY,
    UserID INT NOT NULL,
    BookID INT NOT NULL,
    ReservationDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    ExpiryDate DATETIME NOT NULL,
    Status ENUM('Active','Expired','Cancelled','Fulfilled') DEFAULT 'Active',
    FulfilledBy INT DEFAULT NULL,
    
    FOREIGN KEY (UserID) REFERENCES users(UserID) ON DELETE CASCADE,
    FOREIGN KEY (BookID) REFERENCES book(BookID) ON DELETE CASCADE,
    FOREIGN KEY (FulfilledBy) REFERENCES borrowing_record(BorrowID) ON DELETE SET NULL
);

-- ==========================
-- PENALTY TABLE
-- ==========================
CREATE TABLE penalty (
    PenaltyID INT AUTO_INCREMENT PRIMARY KEY,
    BorrowID INT NOT NULL,
    UserID INT NOT NULL,
    AmountDue DECIMAL(10,2) NOT NULL,
    IssuedDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    PaidDate DATETIME DEFAULT NULL,
    Status ENUM('Pending','Paid','Waived') DEFAULT 'Pending',
    
    FOREIGN KEY (BorrowID) REFERENCES borrowing_record(BorrowID) ON DELETE CASCADE,
    FOREIGN KEY (UserID) REFERENCES users(UserID) ON DELETE CASCADE
);

-- ==========================
-- PAYMENT TABLE
-- ==========================
CREATE TABLE payment (
    PaymentID INT AUTO_INCREMENT PRIMARY KEY,
    UserID INT NOT NULL,
    PenaltyID INT DEFAULT NULL,
    ReservationID INT DEFAULT NULL,
    RecordID INT DEFAULT NULL,
    Amount DECIMAL(10,2) NOT NULL,
    PaymentDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    Method ENUM('Cash','GCash','Card') DEFAULT 'Cash',
    Status ENUM('Pending','Completed') DEFAULT 'Completed',
    
    FOREIGN KEY (UserID) REFERENCES users(UserID) ON DELETE CASCADE,
    FOREIGN KEY (PenaltyID) REFERENCES penalty(PenaltyID) ON DELETE SET NULL,
    FOREIGN KEY (ReservationID) REFERENCES reservation(ReservationID) ON DELETE SET NULL
);

-- ==========================
-- MANAGEMENT LOG TABLE
-- ==========================
CREATE TABLE management_log (
    LogID INT AUTO_INCREMENT PRIMARY KEY,
    UserID INT NOT NULL,
    BookID INT DEFAULT NULL,
    ActionType ENUM('Added','Updated','Archived') NOT NULL,
    Description VARCHAR(255) NOT NULL,
    Timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (UserID) REFERENCES users(UserID) ON DELETE CASCADE
);